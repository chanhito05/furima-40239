<!DOCTYPE html>
<html>
  <head>
    <title>Furima40239</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>
    <script type="text/javascript" src="https://js.pay.jp/v2/pay.js"></script>

    <%= stylesheet_link_tag "application", "data-turbo-track": "reload" %>
    <%= javascript_importmap_tags %>
  </head>
  <body>
    <%= yield %>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const pay = () => {
          if (typeof gon === 'undefined' || typeof gon.public_key === 'undefined') {
            console.error("gonまたはgon.public_keyが定義されていません");
            return;
          }

          const publicKey = gon.public_key;
          const payjp = Payjp(publicKey); // PAY.JPテスト公開鍵
          const elements = payjp.elements();
          const numberElement = elements.create('cardNumber');
          const expiryElement = elements.create('cardExpiry');
          const cvcElement = elements.create('cardCvc');

          numberElement.mount('#number-form');
          expiryElement.mount('#expiry-form');
          cvcElement.mount('#cvc-form');

          const form = document.getElementById('charge-form');
          form.addEventListener("submit", (e) => {
            payjp.createToken(numberElement).then(function (response) {
              if (response.error) {
                // エラー処理
                console.error(response.error.message);
              } else {
                const token = response.id;
                const renderDom = document.getElementById("charge-form");
                const tokenObj = `<input value=${token} name='token' type='hidden'>`;
                renderDom.insertAdjacentHTML("beforeend", tokenObj);
              }
              numberElement.clear();
              expiryElement.clear();
              cvcElement.clear();
              document.getElementById("charge-form").submit();
            });
            e.preventDefault();
          });
        };

        pay();
      });
    </script>
  </body>
</html>